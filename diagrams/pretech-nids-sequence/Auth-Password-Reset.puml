@startuml
title PreTech-NIDS - Auth: Password Reset with OTP
hide circle
autonumber

actor U as "User"
participant FE as "Frontend (Svelte)"
participant BE as "Backend (FastAPI)"
participant EMAIL as "Email Service"
database DB as "MongoDB"

U -> FE : Forgot password
FE -> BE : POST /auth/password-reset/initiate-otp {email}
activate BE
BE -> DB : Check if user exists
DB --> BE : user record
alt User Found
  BE -> BE : generate_otp_code()
  BE -> DB : Store in password_resets {email, otp_code, expires_at, used=false}
  DB --> BE : ack
  BE -> EMAIL : send_reset_otp_email(email, otp_code, username)
  EMAIL --> U : Email with OTP code
  BE --> FE : "Password reset code sent to email"
else User Not Found
  BE --> FE : Error: "User not found"
end
deactivate BE

U -> FE : Enter OTP code
FE -> BE : POST /auth/password-reset/verify-otp {otp_code}
activate BE
BE -> DB : Find reset record {otp_code, used=false, expires_at > now}
DB --> BE : reset record
alt OTP Valid & Not Expired
  BE --> FE : "OTP verified successfully"
else OTP Invalid or Expired
  BE --> FE : Error: "Invalid or expired verification code"
end
deactivate BE

U -> FE : Enter new password
FE -> BE : POST /auth/password-reset/complete {email, new_password}
activate BE
BE -> DB : Find reset record {email, used=false, expires_at > now}
DB --> BE : reset record
alt Reset Session Valid
  BE -> BE : Validate password strength
  BE -> BE : Hash new password
  BE -> DB : Update user password
  DB --> BE : ack
  BE -> DB : Mark reset record as used
  BE --> FE : "Password reset successfully"
else Reset Session Invalid
  BE --> FE : Error: "No valid password reset session found"
end
deactivate BE

@enduml



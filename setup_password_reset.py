#!/usr/bin/env python3
"""
å¯†ç é‡ç½®åŠŸèƒ½å¿«é€Ÿè®¾ç½®è„šæœ¬
"""

import os
import sys

def create_env_file():
    """åˆ›å»º.envæ–‡ä»¶"""
    print("ğŸ”§ åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶...")
    
    if os.path.exists(".env"):
        print("âš ï¸  .envæ–‡ä»¶å·²å­˜åœ¨")
        overwrite = input("æ˜¯å¦è¦†ç›–ï¼Ÿ(y/N): ").strip().lower()
        if overwrite != 'y':
            print("âŒ å–æ¶ˆæ“ä½œ")
            return False
    
    # è·å–ç”¨æˆ·è¾“å…¥
    print("\nğŸ“§ è¯·è¾“å…¥é‚®ä»¶æœåŠ¡å™¨é…ç½®:")
    smtp_server = input("SMTPæœåŠ¡å™¨ (é»˜è®¤: smtp.gmail.com): ").strip() or "smtp.gmail.com"
    smtp_port = input("SMTPç«¯å£ (é»˜è®¤: 587): ").strip() or "587"
    smtp_username = input("é‚®ç®±ç”¨æˆ·å: ").strip()
    smtp_password = input("é‚®ç®±å¯†ç /åº”ç”¨ä¸“ç”¨å¯†ç : ").strip()
    from_email = input("å‘ä»¶äººé‚®ç®± (é»˜è®¤: noreply@pretect-nids.com): ").strip() or "noreply@pretect-nids.com"
    
    if not smtp_username or not smtp_password:
        print("âŒ ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º")
        return False
    
    # åˆ›å»º.envæ–‡ä»¶å†…å®¹
    env_content = f"""# Email Configuration for Password Reset
# Generated by setup script

# SMTP Server Settings
SMTP_SERVER={smtp_server}
SMTP_PORT={smtp_port}
SMTP_USERNAME={smtp_username}
SMTP_PASSWORD={smtp_password}
FROM_EMAIL={from_email}
"""
    
    # å†™å…¥æ–‡ä»¶
    try:
        with open(".env", "w", encoding="utf-8") as f:
            f.write(env_content)
        print("âœ… .envæ–‡ä»¶åˆ›å»ºæˆåŠŸï¼")
        return True
    except Exception as e:
        print(f"âŒ åˆ›å»º.envæ–‡ä»¶å¤±è´¥: {e}")
        return False

def create_upload_dirs():
    """åˆ›å»ºä¸Šä¼ ç›®å½•"""
    print("\nğŸ“ åˆ›å»ºä¸Šä¼ ç›®å½•...")
    
    dirs = ["uploads", "uploads/avatars"]
    
    for dir_path in dirs:
        try:
            os.makedirs(dir_path, exist_ok=True)
            print(f"âœ… åˆ›å»ºç›®å½•: {dir_path}")
        except Exception as e:
            print(f"âŒ åˆ›å»ºç›®å½•å¤±è´¥ {dir_path}: {e}")
            return False
    
    return True

def show_next_steps():
    """æ˜¾ç¤ºåç»­æ­¥éª¤"""
    print("\nğŸ¯ è®¾ç½®å®Œæˆï¼æ¥ä¸‹æ¥éœ€è¦ï¼š")
    print("\n1. æµ‹è¯•é‚®ä»¶é…ç½®:")
    print("   python test_email.py")
    
    print("\n2. å¯åŠ¨åç«¯æœåŠ¡:")
    print("   cd app")
    print("   python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000")
    
    print("\n3. å¯åŠ¨å‰ç«¯æœåŠ¡:")
    print("   cd dashboard")
    print("   npm run dev")
    
    print("\n4. è®¿é—®åº”ç”¨:")
    print("   å‰ç«¯: http://localhost:3000")
    print("   åç«¯: http://localhost:8000")
    
    print("\nğŸ’¡ æç¤º:")
    print("- å¦‚æœä½¿ç”¨Gmailï¼Œè¯·ç¡®ä¿å¯ç”¨äº†ä¸¤æ­¥éªŒè¯å¹¶ç”Ÿæˆäº†åº”ç”¨ä¸“ç”¨å¯†ç ")
    print("- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®ï¼Œç¡®ä¿ç«¯å£8000å’Œ3000å¯è®¿é—®")
    print("- æŸ¥çœ‹PASSWORD_RESET_SETUP.mdè·å–è¯¦ç»†é…ç½®è¯´æ˜")

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸš€ PreTect-NIDS å¯†ç é‡ç½®åŠŸèƒ½è®¾ç½®å‘å¯¼")
    print("=" * 50)
    
    # æ£€æŸ¥Pythonç‰ˆæœ¬
    if sys.version_info < (3, 7):
        print("âŒ éœ€è¦Python 3.7æˆ–æ›´é«˜ç‰ˆæœ¬")
        return
    
    # åˆ›å»º.envæ–‡ä»¶
    if not create_env_file():
        return
    
    # åˆ›å»ºä¸Šä¼ ç›®å½•
    if not create_upload_dirs():
        return
    
    # æ˜¾ç¤ºåç»­æ­¥éª¤
    show_next_steps()
    
    print("\nğŸ‰ è®¾ç½®å®Œæˆï¼")

if __name__ == "__main__":
    main()
